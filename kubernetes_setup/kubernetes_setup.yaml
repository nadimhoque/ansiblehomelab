- hosts: ubuntu_kube
  become: true
  become_user: root
  tasks:
          - name: Update apt repo and cache
            apt: update_cache=yes force_apt_get=yes cache_valid_time=3600
          - name: install kubernetes dependancies
            apt:
              pkg:
              - containerd
              - curl
          - name: Add user Nadim to containerd group
            user:
              name: nadim
              group: nadim
              groups: containerd
              append: yes
          - name: Enable and start the containerd service
            systemd:
                    name: containerd
                    state: started
                    enabled: yes
          - name: Add the kubernetes gpg key for apt
            apt_key:
              url: https://packages.cloud.google.com/apt/doc/apt-key.gpg
              state: present
          - name: Add the kubernetes repo
            apt_repository:
              repo: deb http://apt.kubernetes.io/ kubernetes-xenial main
              state: present
              filename: kubernetes.list
          - name: Install kubernetes
            apt:
              update_cache: yes
              pkg:
              - kubeadm
              - kubelet
              - kubectl
              - kubernetes-cni
          - name: Disable swap
            command: swapoff -a
            become: true
          - name: Disable swap permanently
            replace:
              path: /etc/fstab
              regexp: '^(\s*)([^#\n]+\s+)(\w+\s+)swap(\s+.*)$'
              replace: '#\1\2\3swap\4'
              backup: yes

